pipeline {
    agent {
        docker {
           image 'docker:27.4.0-alpine3.21'
        }
    }
    stages {
        stage ('git clone repo') {
          steps {
            git 'https://github.com/AAM-ITV/demo18.git'   
          }    
        }
        stage ('build and push application') {
          steps {
            script {
             docker.withRegistry('https://hub.docker.com', 'docker-credentials')
               def newApp = docker.build "aamitv/app-jenkins"
               newApp.push()
            }
          }

        }
    
         stage ('deploy application') {
           steps {
                script {
                    def remote = [:]
                    remote.name = 'prod-node'
                    remote.host = '192.168.0.11'     
                    remote.user = 'med'              
                    remote.password = 'bled'       
                    remote.allowAnyHosts = true        

                    sshCommand remote: remote, command: "docker pull aamitv/app-jenkins:latest"

                    
                    sshCommand remote: remote, command: "docker run -d -p 8080:8080 --name app-demo18 aamitv/app-jenkins"
                }
            }
      }

    }
}